<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Gerar Recibo de Empr√©stimo - Biblioteca</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      input,
      button,
      select {
        padding: 8px;
        margin: 5px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
      }
      button {
        background: #4caf50;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #45a049;
      }
      .btn-whatsapp {
        background: #25D366;
        color: white;
      }
      .btn-whatsapp:hover {
        background: #128C7E;
      }
      .form-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }
      .form-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
        flex-wrap: wrap;
      }
      .form-row input,
      .form-row select {
        min-width: 200px;
      }
      #listaLivros {
        margin-top: 20px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        background: white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
        color: #333;
      }
      .contrato {
        background: white;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        margin-top: 20px;
      }
      .campo {
        margin: 5px 0;
      }
      .assinatura {
        margin-top: 50px;
      }
      .assinatura-line {
        border-top: 1px solid #000;
        width: 200px;
        margin-top: 50px;
      }
      .imprimir {
        margin-top: 20px;
        text-align: center;
      }
      .usuario-info {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
      }
      .sugestoes-usuario {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        z-index: 1000;
        width: 300px;
        display: none;
      }
      .sugestao-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .sugestao-item:hover {
        background-color: #f5f5f5;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        .contrato,
        .contrato * {
          visibility: visible;
        }
        .contrato {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
        }
      }
      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
          align-items: stretch;
        }
        .form-row input,
        .form-row select {
          min-width: unset;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <h1>Gerar Recibo de Empr√©stimo</h1>

    <!-- Se√ß√£o de sele√ß√£o do usu√°rio -->
    <div class="form-section">
      <h3>Informa√ß√µes do Usu√°rio</h3>
      
      <div class="form-row">
        <label>Tipo de usu√°rio:</label>
        <select id="tipoUsuario" onchange="alterarTipoUsuario()">
          <option value="cadastrado">Usu√°rio Cadastrado</option>
          <option value="manual">Digitar Manualmente</option>
        </select>
      </div>

      <!-- Para usu√°rio cadastrado -->
      <div id="secaoUsuarioCadastrado" class="form-row">
        <label for="selectUsuario">Selecione o usu√°rio:</label>
        <select id="selectUsuario" onchange="selecionarUsuario()">
          <option value="">Escolha um usu√°rio...</option>
        </select>
        <input type="text" id="buscaUsuario" placeholder="Digite o nome para buscar..." onkeyup="buscarUsuarios()" style="position: relative;">
        <div id="sugestoesUsuario" class="sugestoes-usuario"></div>
      </div>

      <!-- Para digita√ß√£o manual -->
      <div id="secaoUsuarioManual" class="form-row" style="display: none;">
        <input type="text" id="usuarioManual" placeholder="Digite o nome do usu√°rio" />
      </div>

      <!-- Informa√ß√µes do usu√°rio selecionado -->
      <div id="infoUsuarioSelecionado" class="usuario-info" style="display: none;">
        <h4>Usu√°rio Selecionado:</h4>
        <p><strong>Nome:</strong> <span id="nomeUsuarioInfo"></span></p>
        <p><strong>Etapa Formativa:</strong> <span id="etapaUsuarioInfo"></span></p>
        <p><strong>Contato:</strong> <span id="contatoUsuarioInfo"></span></p>
        <button class="btn-whatsapp" id="btnWhatsApp" onclick="abrirWhatsApp()" style="display: none;">
          üì± Enviar WhatsApp
        </button>
      </div>
    </div>

    <!-- Se√ß√£o de adi√ß√£o de livros -->
    <div class="form-section">
      <h3>Adicionar Livros ao Empr√©stimo</h3>
      <div class="form-row">
        <label for="codigoInput">C√≥digo do livro:</label>
        <input type="text" id="codigoInput" placeholder="Ex: LIV123456" />
        <button onclick="adicionarLivro()">Adicionar Livro</button>
      </div>
    </div>

    <div id="listaLivros">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Estante</th>
            <th>Nome</th>
            <th>Autor</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaLista"></tbody>
      </table>
    </div>

    <div class="form-section">
      <button onclick="gerarContrato()">Gerar Recibo de Empr√©stimo</button>
    </div>

    <div
      id="contratoWrapper"
      class="contrato-wrapper"
      style="display: none"
    ></div>

    <div class="imprimir" style="display: none">
      <button onclick="finalizarEmprestimo()">
        üìÑ Imprimir Recibo e Registrar Empr√©stimos
      </button>
      <button class="btn-whatsapp" onclick="enviarNotificacaoEmprestimo()" style="margin-left: 10px;">
        üì± Enviar Notifica√ß√£o WhatsApp
      </button>
    </div>

    <script>
      const API_URL = "/api/livros";
      const API_USUARIOS = "/api/usuarios";
      let livros = [];
      let listaRecibo = [];
      let prazoGlobal = null;
      let usuarioSelecionado = null;
      let todosUsuarios = [];

      // Carrega dados iniciais
      async function carregarDados() {
        await carregarLivros();
        await carregarUsuarios();
      }

      async function carregarLivros() {
        try {
          const res = await fetch(API_URL);
          const data = await res.json();
          livros = data.slice(1);
        } catch (err) {
          console.error("Erro ao carregar livros:", err);
        }
      }

      async function carregarUsuarios() {
        try {
          const res = await fetch(`${API_USUARIOS}/listar`);
          todosUsuarios = await res.json();
          atualizarSelectUsuarios();
        } catch (err) {
          console.error("Erro ao carregar usu√°rios:", err);
        }
      }

      function atualizarSelectUsuarios() {
        const select = document.getElementById('selectUsuario');
        select.innerHTML = '<option value="">Escolha um usu√°rio...</option>';
        
        todosUsuarios.filter(u => u.ativo).forEach(usuario => {
          select.innerHTML += `<option value="${usuario.id}">${usuario.nome} - ${usuario.etapa_formativa}</option>`;
        });
      }

      function alterarTipoUsuario() {
        const tipo = document.getElementById('tipoUsuario').value;
        const secaoCadastrado = document.getElementById('secaoUsuarioCadastrado');
        const secaoManual = document.getElementById('secaoUsuarioManual');
        
        if (tipo === 'cadastrado') {
          secaoCadastrado.style.display = 'flex';
          secaoManual.style.display = 'none';
        } else {
          secaoCadastrado.style.display = 'none';
          secaoManual.style.display = 'flex';
        }
        
        limparSelecaoUsuario();
      }

      function selecionarUsuario() {
        const selectUsuario = document.getElementById('selectUsuario');
        const usuarioId = selectUsuario.value;
        
        if (!usuarioId) {
          limparSelecaoUsuario();
          return;
        }

        usuarioSelecionado = todosUsuarios.find(u => u.id == usuarioId);
        if (usuarioSelecionado) {
          mostrarInfoUsuario();
        }
      }

      async function buscarUsuarios() {
        const termo = document.getElementById('buscaUsuario').value.trim();
        const sugestoes = document.getElementById('sugestoesUsuario');
        
        if (termo.length < 2) {
          sugestoes.style.display = 'none';
          return;
        }

        try {
          const response = await fetch(`${API_USUARIOS}/buscar-por-nome?termo=${encodeURIComponent(termo)}`);
          const usuarios = await response.json();
          
          if (usuarios.length > 0) {
            sugestoes.innerHTML = '';
            usuarios.forEach(usuario => {
              const div = document.createElement('div');
              div.className = 'sugestao-item';
              div.innerHTML = `<strong>${usuario.nome}</strong><br><small>${usuario.etapa_formativa}</small>`;
              div.onclick = () => {
                usuarioSelecionado = usuario;
                document.getElementById('buscaUsuario').value = usuario.nome;
                sugestoes.style.display = 'none';
                mostrarInfoUsuario();
              };
              sugestoes.appendChild(div);
            });
            sugestoes.style.display = 'block';
          } else {
            sugestoes.style.display = 'none';
          }
        } catch (err) {
          console.error('Erro ao buscar usu√°rios:', err);
        }
      }

      function mostrarInfoUsuario() {
        const info = document.getElementById('infoUsuarioSelecionado');
        const btnWhatsApp = document.getElementById('btnWhatsApp');
        
        document.getElementById('nomeUsuarioInfo').textContent = usuarioSelecionado.nome;
        document.getElementById('etapaUsuarioInfo').textContent = usuarioSelecionado.etapa_formativa;
        document.getElementById('contatoUsuarioInfo').textContent = usuarioSelecionado.numero_contato;
        
        info.style.display = 'block';
        btnWhatsApp.style.display = 'inline-block';
      }

      function limparSelecaoUsuario() {
        usuarioSelecionado = null;
        document.getElementById('infoUsuarioSelecionado').style.display = 'none';
        document.getElementById('sugestoesUsuario').style.display = 'none';
        document.getElementById('selectUsuario').value = '';
        document.getElementById('buscaUsuario').value = '';
      }

      function abrirWhatsApp() {
        if (!usuarioSelecionado) return;
        
        const mensagem = encodeURIComponent(`Ol√° ${usuarioSelecionado.nome}, este √© um contato da Biblioteca Amor Divino sobre seus empr√©stimos.`);
        const url = `https://wa.me/${usuarioSelecionado.numero_contato}?text=${mensagem}`;
        window.open(url, '_blank');
      }

      function adicionarLivro() {
        const codigo = document.getElementById("codigoInput").value.trim();
        if (!codigo) {
          alert("Digite um c√≥digo!");
          return;
        }
        
        const livro = livros.find((l) => l[0] === codigo);
        if (!livro) {
          alert("C√≥digo n√£o encontrado!");
          return;
        }

        const status = livro[5]?.toLowerCase();
        if (status !== "dispon√≠vel" && status !== "reservado") {
          alert("Este livro n√£o pode ser emprestado (status: " + livro[5] + ")");
          return;
        }

        if (listaRecibo.some((l) => l[0] === codigo)) {
          alert("Livro j√° adicionado!");
          return;
        }

        if (!prazoGlobal) {
          const hoje = new Date();
          prazoGlobal = new Date();
          prazoGlobal.setDate(hoje.getDate() + 7);
        }

        listaRecibo.push(livro);
        atualizarTabelaLista();
        document.getElementById("codigoInput").value = "";
      }

      function removerLivro(codigo) {
        listaRecibo = listaRecibo.filter((l) => l[0] !== codigo);
        if (listaRecibo.length === 0) prazoGlobal = null;
        atualizarTabelaLista();
      }

      function atualizarTabelaLista() {
        const tbody = document.getElementById("tabelaLista");
        tbody.innerHTML = "";
        listaRecibo.forEach((livro) => {
          tbody.innerHTML += `
          <tr>
            <td>${livro[0]}</td>
            <td>${livro[1]}</td>
            <td>${livro[2]}</td>
            <td>${livro[3]}</td>
            <td>${livro[5]}</td>
            <td><button onclick="removerLivro('${livro[0]}')">Remover</button></td>
          </tr>
        `;
        });
      }

      async function gerarContrato() {
        let nomeUsuario = '';
        
        if (document.getElementById('tipoUsuario').value === 'cadastrado') {
          if (!usuarioSelecionado) {
            alert("Selecione um usu√°rio!");
            return;
          }
          nomeUsuario = usuarioSelecionado.nome;
        } else {
          nomeUsuario = document.getElementById("usuarioManual").value.trim();
          if (!nomeUsuario) {
            alert("Digite o nome do usu√°rio!");
            return;
          }
        }

        if (listaRecibo.length === 0) {
          alert("Adicione pelo menos um livro!");
          return;
        }

        const contratoWrapper = document.getElementById("contratoWrapper");
        contratoWrapper.style.display = "block";
        contratoWrapper.innerHTML = "";

        let contratosHTML = `<div class="contrato"><h2>Recibo de Empr√©stimo de Livros</h2>`;
        contratosHTML += `<div class="campo"><strong>Usu√°rio:</strong> ${nomeUsuario}</div>`;
        
        if (usuarioSelecionado) {
          contratosHTML += `<div class="campo"><strong>Etapa Formativa:</strong> ${usuarioSelecionado.etapa_formativa}</div>`;
        }

        listaRecibo.forEach((livro) => {
          contratosHTML += `
          <div class="campo"><strong>Livro:</strong> ${livro[2]}</div>
          <div class="campo"><strong>Autor:</strong> ${livro[3]}</div>
          <div class="campo"><strong>C√≥digo:</strong> ${livro[0]}</div>
          <div class="campo"><strong>Estante:</strong> ${livro[1]}</div>
          <hr>
        `;
        });

        const prazoTexto = prazoGlobal
          ? prazoGlobal.toLocaleDateString("pt-BR")
          : "___________________";
        contratosHTML += `<div class="campo"><strong>Data de Devolu√ß√£o:</strong> ${prazoTexto}</div>`;

        contratosHTML += `
          <div class="assinatura">
            Assinatura do usu√°rio:
            <div class="assinatura-line"></div>
          </div>
          <div class="assinatura">
            Assinatura do respons√°vel pela biblioteca:
            <div class="assinatura-line"></div>
          </div>
        </div>`;

        contratoWrapper.innerHTML = contratosHTML;
        document.querySelector(".imprimir").style.display = "block";
      }

      async function finalizarEmprestimo() {
        let nomeUsuario = '';
        
        if (document.getElementById('tipoUsuario').value === 'cadastrado') {
          if (!usuarioSelecionado) {
            alert("Selecione um usu√°rio!");
            return;
          }
          nomeUsuario = usuarioSelecionado.nome;
        } else {
          nomeUsuario = document.getElementById("usuarioManual").value.trim();
        }

        const codigos = listaRecibo.map((livro) => livro[0]);
        
        try {
          await fetch("/api/livros/atualizar-status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              codigos: codigos,
              usuario: nomeUsuario,
              status: "Emprestado",
              prazo: prazoGlobal.toISOString().split("T")[0],
            }),
          });
          
          // Registra notifica√ß√£o se for usu√°rio cadastrado
          if (usuarioSelecionado) {
            await fetch(`${API_USUARIOS}/notificacao`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                usuario_id: usuarioSelecionado.id,
                codigo_livro: codigos.join(', '),
                tipo_notificacao: 'emprestimo'
              })
            });
          }
          
          window.print();
        } catch (err) {
          console.error('Erro:', err);
          alert('Erro ao registrar empr√©stimo');
        }
      }

      async function enviarNotificacaoEmprestimo() {
        if (!usuarioSelecionado) {
          alert('Fun√ß√£o dispon√≠vel apenas para usu√°rios cadastrados');
          return;
        }

        const livrosTexto = listaRecibo.map(l => l[2]).join(', ');
        const prazoTexto = prazoGlobal ? prazoGlobal.toLocaleDateString('pt-BR') : '';
        
        const mensagem = encodeURIComponent(
          `Ol√° ${usuarioSelecionado.nome}, confirmamos o empr√©stimo dos livros: ${livrosTexto}. Data de devolu√ß√£o: ${prazoTexto}. - Biblioteca Amor Divino`
        );
        
        const url = `https://wa.me/${usuarioSelecionado.numero_contato}?text=${mensagem}`;
        window.open(url, '_blank');
      }

      // Event listeners
      document.getElementById("codigoInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          adicionarLivro();
        }
      });

      // Esconde sugest√µes quando clica fora
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#buscaUsuario') && !e.target.closest('#sugestoesUsuario')) {
          document.getElementById('sugestoesUsuario').style.display = 'none';
        }
      });

      // Inicializa√ß√£o
      window.onload = carregarDados;
    </script>
  </body>
</html>