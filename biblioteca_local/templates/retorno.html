<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Gerar Recibo de Devolu√ß√£o - Biblioteca</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      h1 {
        text-align: center;
        color: #333;
      }

      input,
      button,
      select {
        padding: 8px;
        margin: 5px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      button {
        background: #f44336;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #d32f2f;
      }

      .btn-whatsapp {
        background: #25d366;
        color: white;
      }
      .btn-whatsapp:hover {
        background: #128c7e;
      }

      .form-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .form-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .usuario-info {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
      }

      .sugestoes-usuario {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        z-index: 1000;
        width: 300px;
        display: none;
      }
      .sugestao-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .sugestao-item:hover {
        background-color: #f5f5f5;
      }

      #listaLivrosDevolucao {
        margin-top: 20px;
      }
      #listaLivrosDevolucao .livro-item {
        margin-bottom: 10px;
      }
      #listaLivrosDevolucao h3 {
        margin-bottom: 10px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        background: white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
        color: #333;
      }

      .contrato {
        background: white;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        margin-top: 20px;
      }
      .campo {
        margin: 5px 0;
      }
      .assinatura {
        margin-top: 50px;
      }
      .assinatura-line {
        border-top: 1px solid #000;
        width: 200px;
        margin-top: 50px;
      }

      .imprimir {
        margin-top: 20px;
        text-align: center;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        .contrato,
        .contrato * {
          visibility: visible;
        }
        .contrato {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <h1>Gerar Recibo de Devolu√ß√£o</h1>

    <div class="form-section">
      <h3>Informa√ß√µes do Usu√°rio</h3>

      <div class="form-row">
        <label>Tipo de usu√°rio:</label>
        <select id="tipoUsuario" onchange="alterarTipoUsuario()">
          <option value="cadastrado">Usu√°rio Cadastrado</option>
          <option value="manual">Digitar Manualmente</option>
        </select>
      </div>

      <div id="secaoUsuarioCadastrado" class="form-row">
        <label for="selectUsuario">Selecione o usu√°rio:</label>
        <select id="selectUsuario" onchange="selecionarUsuario()">
          <option value="">Escolha um usu√°rio...</option>
        </select>
        <input
          type="text"
          id="buscaUsuario"
          placeholder="Digite o nome para buscar..."
          onkeyup="buscarUsuarios()"
          style="position: relative"
        />
        <div id="sugestoesUsuario" class="sugestoes-usuario"></div>
      </div>

      <div id="secaoUsuarioManual" class="form-row" style="display: none">
        <input
          type="text"
          id="usuarioManual"
          placeholder="Digite o nome do usu√°rio"
        />
      </div>

      <div
        id="infoUsuarioSelecionado"
        class="usuario-info"
        style="display: none"
      >
        <h4>Usu√°rio Selecionado:</h4>
        <p><strong>Nome:</strong> <span id="nomeUsuarioInfo"></span></p>
        <p>
          <strong>Etapa Formativa:</strong> <span id="etapaUsuarioInfo"></span>
        </p>
        <p><strong>Contato:</strong> <span id="contatoUsuarioInfo"></span></p>
        <button
          class="btn-whatsapp"
          id="btnWhatsApp"
          onclick="abrirWhatsApp()"
          style="display: none"
        >
          üì± Enviar WhatsApp
        </button>
      </div>
    </div>

    <div id="listaLivrosDevolucao" class="form-section" style="display: none">
      <h3>Livros em posse do usu√°rio:</h3>
      <div id="listaLivros"></div>
    </div>

    <div
      id="contratoWrapper"
      class="contrato-wrapper"
      style="display: none"
    ></div>

    <div class="imprimir" style="display: none">
      <button onclick="finalizarDevolucao()">
        üìÑ Imprimir Recibo e Registrar Devolu√ß√µes
      </button>
      <button
        class="btn-whatsapp"
        onclick="enviarNotificacaoDevolucao()"
        style="margin-left: 10px"
      >
        üì± Enviar Notifica√ß√£o WhatsApp
      </button>
    </div>

    <br />
    <button onclick="gerarContrato()">Gerar Recibo</button>

    <script>
      const API_URL = "/api/livros";
      const API_USUARIOS = "/api/usuarios";
      let todosOsLivros = [];
      let livrosEmprestadosDoUsuario = [];
      let todosUsuarios = [];
      let usuarioSelecionado = null;

      async function carregarLivros() {
        try {
          const res = await fetch(API_URL);
          const data = await res.json();
          todosOsLivros = data.slice(1);
        } catch (err) {
          console.error("Erro ao carregar a lista de livros:", err);
          alert("N√£o foi poss√≠vel carregar a lista de livros.");
        }
      }

      async function carregarUsuarios() {
        try {
          const res = await fetch(`${API_USUARIOS}/listar`);
          todosUsuarios = await res.json();
          atualizarSelectUsuarios();
        } catch (err) {
          console.error("Erro ao carregar usu√°rios:", err);
        }
      }

      function atualizarSelectUsuarios() {
        const select = document.getElementById("selectUsuario");
        select.innerHTML = '<option value="">Escolha um usu√°rio...</option>';
        todosUsuarios
          .filter((u) => u.ativo)
          .forEach((usuario) => {
            select.innerHTML += `<option value="${usuario.id}">${usuario.nome} - ${usuario.etapa_formativa}</option>`;
          });
      }

      function alterarTipoUsuario() {
        const tipo = document.getElementById("tipoUsuario").value;
        document.getElementById("secaoUsuarioCadastrado").style.display =
          tipo === "cadastrado" ? "flex" : "none";
        document.getElementById("secaoUsuarioManual").style.display =
          tipo === "manual" ? "flex" : "none";
        limparSelecaoUsuario();
      }

      async function selecionarUsuario() {
        const usuarioId = document.getElementById("selectUsuario").value;
        if (!usuarioId) {
          limparSelecaoUsuario();
          return;
        }
        usuarioSelecionado = todosUsuarios.find((u) => u.id == usuarioId);
        if (usuarioSelecionado) {
          mostrarInfoUsuario();
          carregarLivrosEmprestados(usuarioId);
        }
      }

      async function buscarUsuarios() {
        const termo = document.getElementById("buscaUsuario").value.trim();
        const sugestoes = document.getElementById("sugestoesUsuario");
        if (termo.length < 2) {
          sugestoes.style.display = "none";
          return;
        }

        try {
          const response = await fetch(
            `${API_USUARIOS}/buscar-por-nome?termo=${encodeURIComponent(termo)}`
          );
          const usuarios = await response.json();
          if (usuarios.length > 0) {
            sugestoes.innerHTML = "";
            usuarios.forEach((usuario) => {
              const div = document.createElement("div");
              div.className = "sugestao-item";
              div.innerHTML = `<strong>${usuario.nome}</strong><br><small>${usuario.etapa_formativa}</small>`;
              div.onclick = () => {
                usuarioSelecionado = usuario;
                document.getElementById("buscaUsuario").value = usuario.nome;
                sugestoes.style.display = "none";
                mostrarInfoUsuario();
                carregarLivrosEmprestados(usuario.id);
              };
              sugestoes.appendChild(div);
            });
            sugestoes.style.display = "block";
          } else sugestoes.style.display = "none";
        } catch (err) {
          console.error("Erro ao buscar usu√°rios:", err);
        }
      }

      function mostrarInfoUsuario() {
        document.getElementById("nomeUsuarioInfo").textContent =
          usuarioSelecionado.nome;
        document.getElementById("etapaUsuarioInfo").textContent =
          usuarioSelecionado.etapa_formativa;
        document.getElementById("contatoUsuarioInfo").textContent =
          usuarioSelecionado.numero_contato;
        document.getElementById("infoUsuarioSelecionado").style.display =
          "block";
        document.getElementById("btnWhatsApp").style.display = "inline-block";
      }

      function limparSelecaoUsuario() {
        usuarioSelecionado = null;
        document.getElementById("infoUsuarioSelecionado").style.display =
          "none";
        document.getElementById("sugestoesUsuario").style.display = "none";
        document.getElementById("selectUsuario").value = "";
        document.getElementById("buscaUsuario").value = "";
        document.getElementById("listaLivrosDevolucao").style.display = "none";
        livrosEmprestadosDoUsuario = [];
      }

      function abrirWhatsApp() {
        if (!usuarioSelecionado) return;
        const mensagem = encodeURIComponent(
          `Ol√° ${usuarioSelecionado.nome}, recebemos a devolu√ß√£o dos seus livros.`
        );
        const url = `https://wa.me/${usuarioSelecionado.numero_contato}?text=${mensagem}`;
        window.open(url, "_blank");
      }

      async function carregarLivrosEmprestados(usuarioId) {
        try {
          const response = await fetch(
            `${API_USUARIOS}/emprestimos/${usuarioId}`
          );
          livrosEmprestadosDoUsuario = await response.json();

          const container = document.getElementById("listaLivrosDevolucao");
          const listaLivros = document.getElementById("listaLivros");
          listaLivros.innerHTML = "";

          if (livrosEmprestadosDoUsuario.length > 0) {
            livrosEmprestadosDoUsuario.forEach((livro) => {
              const div = document.createElement("div");
              div.className = "livro-item";
              div.innerHTML = `
              <input type="checkbox" id="livro-${livro.codigo}" value="${livro.codigo}" checked>
              <label for="livro-${livro.codigo}">${livro.nome} (${livro.codigo})</label>
            `;
              listaLivros.appendChild(div);
            });
            container.style.display = "block";
          } else {
            listaLivros.innerHTML =
              "<p>Nenhum livro emprestado por este usu√°rio.</p>";
            container.style.display = "block";
          }
        } catch (error) {
          console.error("Erro ao carregar livros emprestados:", error);
          alert("Erro ao carregar a lista de livros.");
        }
      }

      function gerarContrato() {
        const tipoUsuario = document.getElementById("tipoUsuario").value;
        let usuarioNome = "";
        let livrosRecibo = [];

        if (tipoUsuario === "cadastrado") {
          if (!usuarioSelecionado) {
            alert("Selecione um usu√°rio!");
            return;
          }
          usuarioNome = usuarioSelecionado.nome;

          const livrosSelecionados = Array.from(
            document.querySelectorAll(
              '#listaLivrosDevolucao input[type="checkbox"]:checked'
            )
          );
          if (livrosSelecionados.length === 0) {
            alert("Selecione pelo menos um livro para gerar o recibo!");
            return;
          }

          livrosRecibo = livrosSelecionados.map((checkbox) => {
            const codigo = checkbox.value;
            return livrosEmprestadosDoUsuario.find((l) => l.codigo === codigo);
          });
        } else {
          // tipo === 'manual'
          usuarioNome = document.getElementById("usuarioManual").value.trim();
          if (!usuarioNome) {
            alert("Digite o nome do usu√°rio!");
            return;
          }

          const codigo = document
            .getElementById("codigoInputManual")
            .value.trim()
            .toLowerCase();
          if (!codigo) {
            alert("Digite um c√≥digo!");
            return;
          }
          const livro = todosOsLivros.find(
            (l) => String(l[0]).toLowerCase() === codigo
          );
          if (!livro) {
            alert("C√≥digo n√£o encontrado!");
            return;
          }
          const status = livro[5]?.toLowerCase();
          if (status !== "emprestado") {
            alert(
              "Este livro n√£o pode ser devolvido (Status atual: " +
                livro[5] +
                ")"
            );
            return;
          }
          livrosRecibo.push(livro);
        }

        if (livrosRecibo.length === 0) {
          alert("Adicione pelo menos um livro!");
          return;
        }

        const contratoWrapper = document.getElementById("contratoWrapper");
        contratoWrapper.style.display = "block";
        let contratosHTML = `<div class="contrato"><h2>Recibo de Devolu√ß√£o de Livros</h2>`;
        contratosHTML += `<div class="campo"><strong>Usu√°rio:</strong> ${usuarioNome}</div>`;
        contratosHTML += `<div class="campo"><strong>Data de Devolu√ß√£o:</strong> ${new Date().toLocaleDateString(
          "pt-BR"
        )}</div><hr>`;

        livrosRecibo.forEach((livro) => {
          // AQUI: Acessamos as propriedades diretamente, j√° que a API corrigida as fornecer√°
          // para ambos os casos ('manual' e 'cadastrado').
          contratosHTML += `
          <div class="campo"><strong>Livro:</strong> ${livro.nome}</div>
          <div class="campo"><strong>Autor:</strong> ${livro.autor}</div>
          <div class="campo"><strong>C√≥digo:</strong> ${livro.codigo}</div>
          <div class="campo"><strong>Estante:</strong> ${livro.estante}</div>
          <hr>`;
        });

        contratosHTML += `
          Assinatura do respons√°vel pela biblioteca:
          <div class="assinatura-line"></div>
        </div></div>`;
        contratoWrapper.innerHTML = contratosHTML;
        document.querySelector(".imprimir").style.display = "block";
      }
      async function finalizarDevolucao() {
        const livrosSelecionados = Array.from(
          document.querySelectorAll(
            '#listaLivrosDevolucao input[type="checkbox"]:checked'
          )
        );

        if (livrosSelecionados.length === 0) {
          alert("Selecione pelo menos um livro para devolver.");
          return;
        }

        try {
          for (const livroCheckbox of livrosSelecionados) {
            const codigo = livroCheckbox.value;
            await fetch(`${API_URL}/atualizar-status`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                codigo: codigo,
                status: "Dispon√≠vel",
                usuario: "",
                prazo: "",
                data_emprestimo: "",
              }),
            });
          }
          alert("Devolu√ß√£o(√µes) registrada(s) com sucesso!");
          window.print();
        } catch (error) {
          console.error("Erro ao finalizar devolu√ß√£o:", error);
          alert("Erro ao registrar a devolu√ß√£o.");
        }
      }

      function enviarNotificacaoDevolucao() {
        if (!usuarioSelecionado) {
          alert("Selecione um usu√°rio!");
          return;
        }
        const livrosSelecionados = Array.from(
          document.querySelectorAll(
            '#listaLivrosDevolucao input[type="checkbox"]:checked'
          )
        );
        const nomesLivros = livrosSelecionados
          .map((checkbox) => {
            const livro = livrosEmprestadosDoUsuario.find(
              (l) => l.codigo === checkbox.value
            );
            return livro ? livro.nome : "";
          })
          .join(", ");

        const mensagem = encodeURIComponent(
          `Ol√° ${usuarioSelecionado.nome}, recebemos a devolu√ß√£o dos livros: ${nomesLivros}.`
        );
        const url = `https://wa.me/${usuarioSelecionado.numero_contato}?text=${mensagem}`;
        window.open(url, "_blank");
      }

      // Carregar dados iniciais
      window.onload = carregarUsuarios;
    </script>
  </body>
</html>
