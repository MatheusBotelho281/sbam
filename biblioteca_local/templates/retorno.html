<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerar Recibo de Devolução - Biblioteca</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { text-align: center; color: #333; }
    input, button { padding: 8px; margin: 5px; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #f44336; color: white; cursor: pointer; }
    button:hover { background: #d32f2f; }
    #listaLivros { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; color: #333; }
    .contrato { background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.2); margin-top: 20px; }
    .campo { margin: 5px 0; }
    .assinatura { margin-top: 50px; }
    .assinatura-line { border-top: 1px solid #000; width: 200px; margin-top: 50px; }
    .imprimir { margin-top: 20px; text-align: center; }

    @media print {
      body * { visibility: hidden; }
      .contrato, .contrato * { visibility: visible; }
      .contrato { position: absolute; top: 0; left: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <h1>Gerar Recibo de Devolução</h1>

  <label for="usuarioInput">Nome do Usuário (para o recibo):</label>
  <input type="text" id="usuarioInput" placeholder="Digite o nome do usuário">

  <br><br>

  <label for="codigoInput">Digite o código do livro para devolução:</label>
  <input type="text" id="codigoInput" placeholder="Ex: LIV123456">
  <button onclick="adicionarLivro()">Adicionar</button>

  <div id="listaLivros">
    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Estante</th>
          <th>Nome</th>
          <th>Autor</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabelaLista"></tbody>
    </table>
  </div>

  <div id="contratoWrapper" class="contrato-wrapper" style="display:none;"></div>

  <div class="imprimir" style="display:none;">
    <button>Imprimir Recibo e Registrar Devoluções</button>
  </div>
  
  <br>
  <button onclick="gerarContrato()">Gerar Recibo</button>

  <script>
    const API_URL = "/api/livros";
    let todosOsLivros = [];
    let listaRecibo = [];

    async function carregarLivros() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        // Armazena todos os livros (pulando o cabeçalho)
        todosOsLivros = data.slice(1); 
      } catch(err) {
        console.error("Erro ao carregar a lista de livros:", err);
        alert("Não foi possível carregar a lista de livros. Verifique se o servidor está rodando.");
      }
    }

    function adicionarLivro() {
      const codigoInput = document.getElementById("codigoInput").value;
      if(!codigoInput){ alert("Digite um código!"); return; }

      // **MUDANÇA IMPORTANTE: Busca robusta e insensível a maiúsculas/minúsculas e espaços**
      const codigoFormatado = codigoInput.toLowerCase().trim();
      const livro = todosOsLivros.find(l => String(l[0]).toLowerCase().trim() === codigoFormatado);

      if(!livro){ 
        alert("Código não encontrado!"); 
        return; 
      }

      const status = livro[5]?.toLowerCase();
      if(status !== "emprestado"){ 
        alert("Este livro não pode ser devolvido (Status atual: " + livro[5] + ")");
        return;
      }

      if(listaRecibo.some(l => l[0] === livro[0])){ 
        alert("Este livro já foi adicionado à lista de devolução!"); 
        return; 
      }

      listaRecibo.push(livro);
      atualizarTabelaLista();
      document.getElementById("codigoInput").value = "";
      document.getElementById("codigoInput").focus();
    }

    function removerLivro(codigo){
      listaRecibo = listaRecibo.filter(l => l[0] !== codigo);
      atualizarTabelaLista();
    }

    function atualizarTabelaLista(){
      const tbody = document.getElementById("tabelaLista");
      tbody.innerHTML = "";
      listaRecibo.forEach(livro => {
        tbody.innerHTML += `
          <tr>
            <td>${livro[0]}</td>
            <td>${livro[1]}</td>
            <td>${livro[2]}</td>
            <td>${livro[3]}</td>
            <td>${livro[5]}</td>
            <td><button onclick="removerLivro('${livro[0]}')">Remover</button></td>
          </tr>
        `;
      });
    }

    async function gerarContrato() {
      const usuario = document.getElementById("usuarioInput").value.trim();
      if(!usuario){ alert("Digite o nome do usuário para gerar o recibo!"); return; }
      if(listaRecibo.length === 0){ alert("Adicione pelo menos um livro à lista!"); return; }

      const contratoWrapper = document.getElementById("contratoWrapper");
      contratoWrapper.style.display = "block";
      
      let contratosHTML = `<div class="contrato"><h2>Recibo de Devolução de Livros</h2>`;
      contratosHTML += `<div class="campo"><strong>Usuário:</strong> ${usuario}</div>`;
      contratosHTML += `<div class="campo"><strong>Data de Devolução:</strong> ${new Date().toLocaleDateString('pt-BR')}</div><hr>`;

      listaRecibo.forEach(livro => {
        contratosHTML += `
          <div class="campo"><strong>Livro:</strong> ${livro[2]}</div>
          <div class="campo"><strong>Autor:</strong> ${livro[3]}</div>
          <div class="campo"><strong>Código:</strong> ${livro[0]}</div>
          <div class="campo"><strong>Estante:</strong> ${livro[1]}</div>
          <hr>
        `;
      });

      contratosHTML += `
          <p style="margin-top: 20px;">Recebido em bom estado por:</p>
          <div class="assinatura">
            Assinatura do responsável pela biblioteca:
            <div class="assinatura-line"></div>
          </div>
        </div>`;

      contratoWrapper.innerHTML = contratosHTML;
      document.querySelector('.imprimir').style.display = "block";
    }
    
    // **MUDANÇA IMPORTANTE: Lógica de envio para a API local**
    document.querySelector('.imprimir button').onclick = async function(){
        if(listaRecibo.length === 0){
            alert("Nenhum livro na lista para registrar a devolução.");
            return;
        }

        const codigosParaDevolver = listaRecibo.map(livro => livro[0]);

        try {
            const response = await fetch('/api/livros/atualizar-status', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    codigos: codigosParaDevolver,
                    usuario: "",
                    status: "Disponível",
                    prazo: ""
                })
            });

            if (!response.ok) {
                throw new Error('Falha ao registrar a devolução no servidor.');
            }

            // Apenas imprime se a atualização no servidor for bem-sucedida
            window.print();
            
            // Limpa a lista e recarrega os dados mestre
            listaRecibo = [];
            atualizarTabelaLista();
            carregarLivros();
            document.getElementById("contratoWrapper").style.display = "none";
            document.querySelector('.imprimir').style.display = "none";

        } catch (err) {
            alert(`Erro: ${err.message}`);
            console.error("Erro ao registrar devolução: ", err);
        }
    };


    document.getElementById("codigoInput").addEventListener("keydown", function(e){
      if(e.key === "Enter"){
        e.preventDefault();
        adicionarLivro();
      }
    });

    // Carrega a lista de todos os livros quando a página é aberta
    carregarLivros();
  </script>

</body>
</html>